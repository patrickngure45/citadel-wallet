// Citadel - Autonomous Capital Allocation System
// Prisma Schema - 13 Core Models
// Generated: 2026-01-30

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════════════════════════════
// USERS - Authentication & Profile
// ═══════════════════════════════════════════════════════════════════
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String?
  phone             String?
  phoneVerified     Boolean   @default(false)
  emailVerified     Boolean   @default(false)
  avatar            String?
  
  // KYC & Compliance
  kycStatus         String    @default("pending") // pending, approved, rejected
  kycSubmittedAt    DateTime?
  kycApprovedAt     DateTime?
  riskProfile       String    @default("moderate") // conservative, moderate, aggressive
  
  // Account Status
  status            String    @default("active") // active, suspended, closed
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  wallets           Wallet[]
  strategies        Strategy[]
  stakingRecords    TSTStake[]
  p2pAgreements     P2PAgreement[] @relation("borrower")
  lenderAgreements  P2PAgreement[] @relation("lender")
  apiKeys           APIKey[]
  performanceMetrics PerformanceMetric[]
  auditTrail        AuditTrail[]
  
  @@index([email])
  @@index([kycStatus])
}

// ═══════════════════════════════════════════════════════════════════
// WALLETS - Multi-Chain Wallet Management
// ═══════════════════════════════════════════════════════════════════
model Wallet {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Wallet Info
  address           String    @unique // User's unique deposit address
  chain             String    // "bsc", "polygon"
  walletType        String    @default("user") // user, master, hot
  derivationPath    String?   // BIP44 path (m/44'/60'/0'/0/1, etc)
  
  // Balances
  balanceUSDT       Decimal   @default(0) @db.Decimal(28, 8)
  balanceUSDC       Decimal   @default(0) @db.Decimal(28, 8)
  balanceNative    Decimal   @default(0) @db.Decimal(28, 8) // BNB or MATIC
  balanceTST       Decimal   @default(0) @db.Decimal(28, 8)
  
  // Metadata
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  transactions      Transaction[]
  
  @@unique([userId, chain])
  @@index([address])
  @@index([userId])
}

// ═══════════════════════════════════════════════════════════════════
// TRANSACTIONS - On-Chain Activity
// ═══════════════════════════════════════════════════════════════════
model Transaction {
  id                String    @id @default(cuid())
  walletId          String
  wallet            Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction Details
  txHash            String    @unique
  type              String    // "deposit", "withdrawal", "sweep", "reward"
  status            String    @default("pending") // pending, confirmed, failed
  amount            Decimal   @db.Decimal(28, 8)
  assetType         String    // "usdt", "usdc", "native", "tst"
  chain             String    // "bsc", "polygon"
  
  // Blockchain Data
  fromAddress       String
  toAddress         String
  gasUsed           Decimal?  @db.Decimal(20, 8)
  gasPaid           Decimal?  @db.Decimal(28, 8)
  blockNumber       BigInt?
  blockTimestamp    DateTime?
  
  // Metadata
  createdAt         DateTime  @default(now())
  confirmedAt       DateTime?
  
  @@index([walletId])
  @@index([txHash])
  @@index([status])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════
// STRATEGIES - Trading Strategies
// ═══════════════════════════════════════════════════════════════════
model Strategy {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Strategy Info
  name              String
  description       String?
  type              String    // "dca", "trend_following", "mean_reversion", "arbitrage"
  
  // Strategy Parameters
  initialCapital    Decimal   @db.Decimal(28, 8)
  currentValue      Decimal   @db.Decimal(28, 8)
  targetAsset       String    // "BTC", "ETH", "BNB", etc
  
  // Status
  status            String    @default("paused") // active, paused, completed, failed
  vetoStatus        String    @default("none") // none, pending, vetoed, approved
  
  // Performance
  totalReturn       Decimal   @default(0) @db.Decimal(28, 8)
  returnPercentage  Decimal   @default(0) @db.Decimal(10, 4)
  winRate           Decimal   @default(0) @db.Decimal(5, 2)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  startedAt         DateTime?
  endedAt           DateTime?
  updatedAt         DateTime  @updatedAt
  
  // Relations
  decisions         StrategyDecision[]
  
  @@index([userId])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════
// STRATEGY DECISIONS - Entity System Decisions
// ═══════════════════════════════════════════════════════════════════
model StrategyDecision {
  id                String    @id @default(cuid())
  strategyId        String
  strategy          Strategy  @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  
  // Decision Details
  decision          String    // "buy", "sell", "hold"
  confidence        Decimal   @db.Decimal(5, 4) // 0.0 - 1.0
  reasoning         String
  
  // Entity Inputs
  perceptionScore   Decimal   @db.Decimal(5, 4)
  memoryScore       Decimal   @db.Decimal(5, 4)
  riskScore         Decimal   @db.Decimal(5, 4)
  
  // Execution
  executed          Boolean   @default(false)
  executionPrice    Decimal?  @db.Decimal(28, 8)
  executionTxHash   String?
  
  // Metadata
  createdAt         DateTime  @default(now())
  executedAt        DateTime?
  
  @@index([strategyId])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════
// ENTITY LOGS - Audit Trail for Entity System
// ═══════════════════════════════════════════════════════════════════
model EntityLog {
  id                String    @id @default(cuid())
  
  // Entity Info
  entityType        String    // "perception", "memory", "risk", "strategy", "execution"
  cycle             Int       // Cycle number
  
  // Cycle Data
  startTime         DateTime
  endTime           DateTime
  duration          Int       // milliseconds
  
  // Metrics
  dataPointsProcessed Int
  anomaliesDetected Int
  decisionsGenerated Int
  
  // Status
  status            String    // "success", "error", "timeout"
  errorMessage      String?
  
  // Metadata
  createdAt         DateTime  @default(now())
  
  @@index([entityType])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════
// GUARDIAN CHECKS - Risk & Anomaly Detection
// ═══════════════════════════════════════════════════════════════════
model GuardianCheck {
  id                String    @id @default(cuid())
  
  // Check Info
  checkType         String    // "withdrawal_limit", "unusual_activity", "price_spike", "multiple_fails"
  severity          String    // "low", "medium", "high", "critical"
  
  // Check Details
  userId            String?
  strategyId        String?
  description       String
  anomalyScore      Decimal   @db.Decimal(5, 4)
  
  // Approval Workflow
  status            String    @default("pending") // pending, approved, rejected, auto-approved
  approverNotes     String?
  approvedAt        DateTime?
  
  // Metadata
  createdAt         DateTime  @default(now())
  resolvedAt        DateTime?
  
  @@index([userId])
  @@index([checkType])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════
// TST STAKING - Token Staking & Rewards
// ═══════════════════════════════════════════════════════════════════
model TSTStake {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Staking Info
  amount            Decimal   @db.Decimal(28, 8)
  stakedAt          DateTime  @default(now())
  
  // Rewards (8% APY)
  totalRewardsEarned Decimal  @default(0) @db.Decimal(28, 8)
  rewardsClaimed    Decimal   @default(0) @db.Decimal(28, 8)
  rewardsUnclaimed  Decimal   @default(0) @db.Decimal(28, 8)
  
  // Status
  status            String    @default("active") // active, unstaking, unstaked
  unstakedAt        DateTime?
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([userId])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════
// P2P LENDING - Peer-to-Peer Lending Agreements
// ═══════════════════════════════════════════════════════════════════
model P2PAgreement {
  id                String    @id @default(cuid())
  
  // Parties
  borrowerId        String
  borrower          User      @relation("borrower", fields: [borrowerId], references: [id], onDelete: Cascade)
  lenderId          String
  lender            User      @relation("lender", fields: [lenderId], references: [id], onDelete: Cascade)
  
  // Loan Details
  principalAmount   Decimal   @db.Decimal(28, 8)
  interestRate      Decimal   @db.Decimal(5, 2) // percentage
  duration          Int       // days
  assetType         String    // "usdt", "usdc"
  
  // Status
  status            String    @default("pending") // pending, active, repaid, defaulted
  approvalCount     Int       @default(0) // Multi-sig: 0/2/3
  lenderApproved    Boolean   @default(false)
  borrowerApproved  Boolean   @default(false)
  
  // Funds
  disbursedAt       DateTime?
  repaidAt          DateTime?
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([borrowerId])
  @@index([lenderId])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════
// API KEYS - Developer API Access
// ═══════════════════════════════════════════════════════════════════
model APIKey {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Key Info
  name              String
  keyPrefix         String    // First 8 chars visible to user
  keyHash           String    @unique // Full key hashed
  
  // Tier
  tier              String    @default("free") // free, pro, enterprise
  
  // Limits
  requestsPerDay    Int       @default(100)
  requestsUsedToday Int       @default(0)
  
  // Status
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  expiresAt         DateTime?
  lastUsedAt        DateTime?
  
  @@index([userId])
  @@index([keyHash])
}

// ═══════════════════════════════════════════════════════════════════
// PERFORMANCE METRICS - Daily Snapshots
// ═══════════════════════════════════════════════════════════════════
model PerformanceMetric {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Date
  date              DateTime  @unique
  
  // Portfolio Metrics
  totalValue        Decimal   @db.Decimal(28, 8)
  totalDeposits     Decimal   @db.Decimal(28, 8)
  totalWithdrawals  Decimal   @db.Decimal(28, 8)
  totalReturn       Decimal   @db.Decimal(28, 8)
  returnPercentage  Decimal   @db.Decimal(10, 4)
  
  // Risk Metrics
  volatility        Decimal   @db.Decimal(5, 4)
  sharpeRatio       Decimal   @db.Decimal(5, 2)
  maxDrawdown       Decimal   @db.Decimal(5, 4)
  
  // Metadata
  createdAt         DateTime  @default(now())
  
  @@index([userId])
  @@index([date])
}

// ═══════════════════════════════════════════════════════════════════
// AUDIT TRAIL - Compliance & Logging
// ═══════════════════════════════════════════════════════════════════
model AuditTrail {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Action Details
  action            String    // "login", "deposit", "withdrawal", "strategy_create", etc
  resourceType      String?   // "wallet", "strategy", "agreement"
  resourceId        String?
  
  // Context
  ipAddress         String?
  userAgent         String?
  status            String    // "success", "failure"
  
  // Changes
  oldValue           String?
  newValue           String?
  
  // Metadata
  createdAt         DateTime  @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════════
// FEATURE FLAGS - Feature Toggles
// ═══════════════════════════════════════════════════════════════════
model FeatureFlag {
  id                String    @id @default(cuid())
  
  // Flag Info
  name              String    @unique
  description       String?
  isEnabled         Boolean   @default(false)
  
  // Rollout
  rolloutPercentage Int       @default(0) // 0-100
  targetUsers       String[]  // User IDs to enable for
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([name])
}
